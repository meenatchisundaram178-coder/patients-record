<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Add New Patient</title>

<style>
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #0099cc, #00c6a7);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 40px;
}

.container {
    width: 80%;
    max-width: 1200px;
    background: #ffffff;
    padding: 30px 40px;
    border-radius: 12px;
    box-shadow: 0px 6px 25px rgba(0,0,0,0.1);
}

h2 {
    margin: 0 0 20px;
}

.section-title {
    font-weight: bold;
    margin-top: 25px;
    margin-bottom: 10px;
    color: #0d8a5a;
    font-size: 18px;
}

.grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}

.grid-4 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

label {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

input, select, textarea {
    width: 80%;
    padding: 10px;
    border: 1px solid #dcdcdc;
    border-radius: 5px;
    font-size: 14px;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border: 1px solid #0d8a5a;
    box-shadow: 0 0 4px rgba(0,0,0,0.15);
}

textarea {
    min-height: 90px;
}

.buttons {
    text-align: right;
    margin-top: 25px;
}

.cancel-btn {
    padding: 8px 18px;
    border: 1px solid #333;
    border-radius: 5px;
    background: #fff;
    cursor: pointer;
}

.add-btn {
    padding: 10px 20px;
    border-radius: 5px;
    background: #0d8a5a;
    color: white;
    border: none;
    cursor: pointer;
    margin-left: 10px;
}

.checkbox-dropdown {
    position: relative;
    width: 300px;
    font-size: 15px;
}

.checkbox-dropdown-button {
    padding: 12px;
    border: 1px solid #aaa;
    border-radius: 6px;
    cursor: pointer;
    background: white;
    font-size: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.checkbox-dropdown-button::after {
    content: "â–¼";
    font-size: 12px;
    color: #333;
}

.checkbox-list {
    display: none;
    position: absolute;
    width: 100%;
    max-height: 230px;
    overflow-y: auto;
    overflow-x: auto;
    background: white;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 15px;
    z-index: 10;
}

.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px 20px;
}

.checkbox-grid label {
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.checkbox-grid input {
    width: 16px;
    height: 16px;
}

@media (max-width: 768px) {
    body { padding: 10px; }
    .container { padding: 15px; }
    .grid { grid-template-columns: 1fr !important; }
    .grid-4 { grid-template-columns: 1fr 1fr !important; }
    .buttons { text-align: center; }
    .add-btn, .cancel-btn { width: 45%; margin-top: 10px; }
}

@media (max-width: 480px) {
    .grid-4 { grid-template-columns: 1fr !important; }
    .checkbox-grid { grid-template-columns: 1fr !important; }
    .add-btn, .cancel-btn { width: 100%; margin-left: 0; }
}
</style>
</head>

<body>

<div class="container">
    <h2>ADD NEW PATIENT</h2>

    <!-- BASIC INFORMATION -->
    <div class="section-title">BASIC INFORMATION</div>

    <div class="grid">
        <div>
            <label>Branch *</label>
                <select id="branch">
                    <option value="" disabled selected>Select branch</option>
                    <option value="Tirupattur">Tirupattur</option>
                    <option value="Uthangarai">Uthangarai</option>
                 </select>
        </div>

        <div>
            <label>Full Name *</label>
            <input type="text" id="fullName" placeholder="Enter full name" />
        </div>

        <div>
            <label>Age *</label>
            <input type="number" id="age" placeholder="Age" />
        </div>

        <div>
            <label>Gender *</label>
                <select id="gender">
                    <option value="" disabled selected>Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
        </div>

        <div>
            <label>Contact *</label>
            <input type="text" id="phone" placeholder="Phone number" />
        </div>

        <div>
            <label>Email</label>
            <input type="email" id="email" placeholder="example@gmail.com" />
        </div>

        <div>
            <label>Address</label>
            <input type="text" id="address" placeholder="Enter address" />
        </div>
    </div>

    <!-- RIGHT EYE -->
    <div class="section-title">RIGHT EYE (OD) PRESCRIPTION</div>
    <div class="grid-4">
        <div><label>SPH</label><input type="text" id="sph_od" placeholder="e.g., -2.00" /></div>
        <div><label>CYL</label><input type="text" id="cyl_od" placeholder="e.g., -0.50" /></div>
        <div><label>AXIS</label><input type="text" id="axis_od" placeholder="e.g., 180" /></div>
        <div><label>ADD</label><input type="text" id="add_od" placeholder="e.g., +2.00" /></div>
    </div>

    <!-- LEFT EYE -->
    <div class="section-title">LEFT EYE (OS) PRESCRIPTION</div>
    <div class="grid-4">
        <div><label>SPH</label><input type="text" id="sph_os" placeholder="e.g., -2.25" /></div>
        <div><label>CYL</label><input type="text" id="cyl_os" placeholder="e.g., -0.75" /></div>
        <div><label>AXIS</label><input type="text" id="axis_os" placeholder="e.g., 90" /></div>
        <div><label>ADD</label><input type="text" id="add_os" placeholder="e.g., +2.00" /></div>
    </div>

    <!-- VISION -->
    <div class="section-title">VISION & MEASUREMENTS</div>
    <div class="grid">
        <div>
            <label>Vision (OD)</label>
            <input type="text" id="vision_od" placeholder="e.g., 20/20" />
        </div>
        <div>
            <label>Vision (OS)</label>
            <input type="text" id="vision_os" placeholder="e.g., 20/40" />
        </div>
        <div>
            <label>PD (Pupillary Distance)</label>
            <input type="text" id="pd" placeholder="e.g., 63mm" />
        </div>
    </div>

    <!-- EYEWEAR DETAILS -->
    <div class="section-title">EYEWEAR DETAILS</div>
    <div class="grid">
        <div>
            <label>Frame Type</label>
                <select id="frameType">
                    <option value="" disabled selected>Select Frame Type</option>
                    <option value="Full-rim">Full-rim</option>
                    <option value="Semi-rimless">Semi-rimless</option>
                    <option value="Rimless">Rimless</option>
                </select>
        </div>

        <div>
            <label>Lens Type</label>
            <select id="lensType">
                <option value="" disabled selected>Select Lens Type</option>
                <option value="Single Vision">Single Vision</option>
                <option value="Bifocal">Bifocal</option>
                <option value="Progressive">Progressive</option>
            </select>
        </div>

        <div class="form-group">
            <label>Lens Coating</label>
            <div class="checkbox-dropdown">
                <div class="checkbox-dropdown-button" onclick="toggleCoatingDropdown()">Select Coatings</div>
                <div class="checkbox-list" id="coatingList">
                    <div class="checkbox-grid">
                        <label><input type="checkbox" value="Crizal"> Crizal</label>
                        <label><input type="checkbox" value="Prevencia"> Prevencia</label>
                        <label><input type="checkbox" value="Blue Block"> Blue Block</label>
                        <label><input type="checkbox" value="S92"> S92</label>
                        <label><input type="checkbox" value="PG"> PG</label>
                        <label><input type="checkbox" value="Krypto"> Krypto</label>
                        <label><input type="checkbox" value="DBF"> DBF</label>
                        <label><input type="checkbox" value="Essilor"> Essilor</label>
                        <label><input type="checkbox" value="Progressive"> Progressive</label>
                        <label><input type="checkbox" value="Free Form"> Free Form</label>
                        <label><input type="checkbox" value="GKB Swiss"> GKB Swiss</label>
                        <label><input type="checkbox" value="Glass"> Glass</label>
                        <label><input type="checkbox" value="CR"> CR</label>
                        <label><input type="checkbox" value="Hindex"> Hindex</label>
                        <label><input type="checkbox" value="ARC"> ARC</label>
                        <label><input type="checkbox" value="Promax"> Promax</label>
                        <label><input type="checkbox" value="Kodak"> Kodak</label>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <label>Contact Lens Type</label>
            <input type="text" id="contactLens" placeholder="e.g., Daily, Monthly" />
        </div>
    </div>

    <!-- ADDITIONAL INFORMATION -->
    <div class="section-title">ADDITIONAL INFORMATION</div>
    <label>Systemic History</label>
    <textarea id="systemicHistory" placeholder="Diabetes, Hypertension, Thyroid..."></textarea>
    <label>Ocular History</label>
    <textarea id="ocularHistory" placeholder="Eye surgeries, previous issues..."></textarea>
    <label>Eye Conditions</label>
    <textarea id="eyeConditions" placeholder="Any eye conditions or concerns"></textarea>
    <label>Notes</label>
    <textarea id="notes" placeholder="Additional notes"></textarea>
    <label>Next Appointment</label>
    <input type="date" id="nextAppointment" />

    <!-- PAYMENT DETAILS -->
    <div class="section-title">PAYMENT DETAILS</div>
    <div class="grid">
        <div>
            <label>Total Amount *</label>
            <input type="number" id="total" placeholder="Total Amount">
        </div>
        <div>
            <label>Advance *</label>
            <input type="number" id="advance" placeholder="Advance Paid">
        </div>
        <div>
            <label>Remaining Amount</label>
            <input type="number" id="remaining" readonly>
        </div>
    </div>

    <!-- BUTTONS -->
    <div class="buttons">
        <button class="cancel-btn" onclick="window.history.back()">Cancel</button>
        <button class="add-btn">Save Patient</button>
    </div>
</div>

<script>
function toggleCoatingDropdown() {
    let list = document.getElementById("coatingList");
    list.style.display = (list.style.display === "block") ? "none" : "block";
}

// Calculate remaining amount
document.getElementById("total").addEventListener("input", calculateRemaining);
document.getElementById("advance").addEventListener("input", calculateRemaining);

function calculateRemaining() {
    let total = Number(document.getElementById("total").value);
    let advance = Number(document.getElementById("advance").value);
    let remaining = total - advance;
    document.getElementById("remaining").value = remaining >= 0 ? remaining : 0;
}

// Load patient if edit
const urlParams = new URLSearchParams(window.location.search);
const patientId = urlParams.get("id");

if (patientId) {
    fetch(`https://pateintrecords.onrender.com/patient/${patientId}`)
    .then(res => res.json())
    .then(p => {
        document.getElementById("branch").value = p.branch || "";
        document.getElementById("fullName").value = p.name || "";
        document.getElementById("age").value = p.age || "";
        document.getElementById("gender").value = p.gender || "";
        document.getElementById("phone").value = p.phone || "";
        document.getElementById("email").value = p.email || "";
        document.getElementById("address").value = p.address || "";
        document.getElementById("sph_od").value = p.sph_od || "";
        document.getElementById("cyl_od").value = p.cyl_od || "";
        document.getElementById("axis_od").value = p.axis_od || "";
        document.getElementById("add_od").value = p.add_od || "";
        document.getElementById("sph_os").value = p.sph_os || "";
        document.getElementById("cyl_os").value = p.cyl_os || "";
        document.getElementById("axis_os").value = p.axis_os || "";
        document.getElementById("add_os").value = p.add_os || "";
        document.getElementById("vision_od").value = p.vision_od || "";
        document.getElementById("vision_os").value = p.vision_os || "";
        document.getElementById("pd").value = p.pd || "";
        document.getElementById("systemicHistory").value = p.systemicHistory || "";
        document.getElementById("ocularHistory").value = p.ocularHistory || "";
        document.getElementById("eyeConditions").value = p.eyeConditions || "";
        document.getElementById("notes").value = p.notes || "";
        document.getElementById("nextAppointment").value = p.nextAppointment || "";
        document.getElementById("total").value = p.total || "";
        document.getElementById("advance").value = p.advance || "";
        document.getElementById("remaining").value = p.remaining || "";
        document.getElementById("frameType").value = p.frameType || "";
        document.getElementById("lensType").value = p.lensType || "";
        document.getElementById("contactLens").value = p.contactLens || "";

        if(p.coatings && p.coatings.length){
            document.querySelectorAll("#coatingList input[type='checkbox']").forEach(ch => {
                if(p.coatings.includes(ch.value)) ch.checked = true;
            });
        }
    })
    .catch(err => console.log(err));
}

// Save or update patient
document.querySelector(".add-btn").onclick = async () => {
    let coatings = Array.from(document.querySelectorAll("#coatingList input[type='checkbox']:checked")).map(c => c.value);

    let patientData = {
        branch: document.getElementById("branch").value,
        name: document.getElementById("fullName").value,
        age: document.getElementById("age").value,
        gender: document.getElementById("gender").value,
        phone: document.getElementById("phone").value,
        email: document.getElementById("email").value,
        address: document.getElementById("address").value,
        sph_od: document.getElementById("sph_od").value,
        cyl_od: document.getElementById("cyl_od").value,
        axis_od: document.getElementById("axis_od").value,
        add_od: document.getElementById("add_od").value,
        sph_os: document.getElementById("sph_os").value,
        cyl_os: document.getElementById("cyl_os").value,
        axis_os: document.getElementById("axis_os").value,
        add_os: document.getElementById("add_os").value,
        vision_od: document.getElementById("vision_od").value,
        vision_os: document.getElementById("vision_os").value,
        pd: document.getElementById("pd").value,
        systemicHistory: document.getElementById("systemicHistory").value,
        ocularHistory: document.getElementById("ocularHistory").value,
        eyeConditions: document.getElementById("eyeConditions").value,
        notes: document.getElementById("notes").value,
        nextAppointment: document.getElementById("nextAppointment").value,
        total: document.getElementById("total").value,
        advance: document.getElementById("advance").value,
        remaining: document.getElementById("remaining").value,
        coatings: coatings,
        frameType: document.getElementById("frameType").value,
        lensType: document.getElementById("lensType").value,
        contactLens: document.getElementById("contactLens").value
    };

    try {
        let url = 'https://pateintrecords.onrender.com/add-patient';
        let method = 'POST';
        if(patientId){
            url = `https://pateintrecords.onrender.com/update-patient/${patientId}`;
            method = 'PUT';
        }

        let res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(patientData)
        });

        let data = await res.json();
        if(res.ok && data.status === "success"){
            alert("Patient saved successfully!");
            window.location.href = "Patient Records.html";
        } else {
            alert("Error: " + (data.message || "Something went wrong"));
        }
    } catch(err) {
        alert("Error: " + err.message);
    }
};
</script>

</body>
</html>
